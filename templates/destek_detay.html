{% extends "base.html" %}

{% block content %}
<style>
    /* Kendi Mesajım (Yeşil, sağa yaslı) */
    .msg-benim {
        background-color: #dcf8c6 !important;
        border-top-right-radius: 0 !important;
        border-top-left-radius: 1rem !important;
        margin-left: auto;
    }

    /* Karşı Taraf (Beyaz, sola yaslı) */
    .msg-karsi {
        background-color: #ffffff !important;
        border-top-right-radius: 1rem !important;
        border-top-left-radius: 0 !important;
        margin-right: auto;
    }
</style>

<div class="container py-3" style="max-width: 800px;">

    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3 reveal-up">
        
        <div class="d-flex align-items-center">
            <a href="/admin/talepler" class="btn btn-light btn-icon-circle me-3 shadow-sm flex-shrink-0">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h5 class="fw-bold mb-0 text-dark">Destek #{{ talep.id }}</h5>
                    {% if talep.durum == 'Açık' %}
                        <span class="badge bg-success rounded-pill small">AÇIK</span>
                    {% else %}
                        <span class="badge bg-secondary rounded-pill small">KAPALI</span>
                    {% endif %}
                </div>
                <p class="text-muted mb-0 small text-truncate" style="max-width: 200px;">
                    {{ talep.konu }}
                </p>
            </div>
        </div>
        
        <div class="d-flex gap-2 ms-auto ms-sm-0">
            {% if current_user.role == 'admin' %}
            <a href="/admin/talepler/durum/{{ talep.id }}" class="btn btn-outline-warning btn-sm btn-oval shadow-sm">
                <i class="fas fa-power-off me-1"></i><span class="d-none d-sm-inline">Durum</span>
            </a>
            <a href="/admin/talepler/sil/{{ talep.id }}" class="btn btn-outline-danger btn-sm btn-oval shadow-sm" onclick="return confirm('Bu talebi silmek istediğine emin misin?')">
                <i class="fas fa-trash me-1"></i><span class="d-none d-sm-inline">Sil</span>
            </a>
            {% endif %}
        </div>
    </div>

    <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-4 reveal-up" style="background: #e5ddd5;">
        <div class="card-body p-3 p-md-4" style="height: 60vh; max-height: 500px; overflow-y: auto; display: flex; flex-direction: column;">
            
            {% for mesaj in talep.mesajlar %}
                
                {% set is_me = (mesaj.gonderen_id == current_user.id) %}

                <div class="d-flex mb-3 w-100">
                    
                    <div class="p-3 rounded-4 shadow-sm position-relative {{ 'msg-benim' if is_me else 'msg-karsi' }}" 
                         style="max-width: 85%; min-width: 140px;">
                        
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small fw-bold {{ 'text-success' if is_me else 'text-primary' }}" style="font-size: 0.8rem;">
                                {{ 'Ben' if is_me else mesaj.gonderen_isim }}
                            </span>
                            {% if mesaj.is_admin and not is_me %}
                                <span class="badge bg-danger ms-2" style="font-size: 0.5rem;">YÖNETİCİ</span>
                            {% endif %}
                        </div>

                        <div class="text-dark mb-1" style="white-space: pre-wrap; font-size: 0.95rem;">{{ mesaj.icerik }}</div>

                        <div class="text-end line-height-1">
                            <small class="text-muted opacity-75" style="font-size: 0.65rem;">
                                {{ mesaj.tarih.strftime('%H:%M') }}
                                {% if is_me %} <i class="fas fa-check-double text-primary ms-1" style="font-size: 0.6rem;"></i> {% endif %}
                            </small>
                        </div>

                    </div>
                </div>

            {% else %}
                <div class="text-center mt-auto mb-auto">
                    <span class="badge bg-light text-dark p-3 rounded-pill shadow-sm">Henüz mesaj yok. İlk mesajı sen yaz!</span>
                </div>
            {% endfor %}

        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 reveal-up">
        <div class="card-body p-2 p-md-3">
            <form method="POST" class="d-flex gap-2 align-items-center">
                <input type="text" name="icerik" class="form-control form-control-oval bg-light border-0 py-2 ps-3" placeholder="Bir mesaj yazın..." required autocomplete="off">
                <button type="submit" class="btn btn-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center flex-shrink-0" style="width: 45px; height: 45px;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

</div>

<script>
    window.onload = function() {
        var cardBody = document.querySelector('.card-body[style*="overflow-y: auto"]');
        if(cardBody) cardBody.scrollTop = cardBody.scrollHeight;
    };
</script>
{% endblock %}